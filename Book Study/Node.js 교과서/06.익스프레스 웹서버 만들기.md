웹서버를 만들떄 효과적으로 만들수 있게 지원하는 `express`에 대해서 알아봅니다.

## 익스프레스 프로젝트 시작하기 
* npm을 통해서 프로젝트를 셋팅합니다. 
```js
npm init
// express 설치
npm i express
// nodemon 설치 - 서버재시작 없이 서버 반영
npm i -D nodemon
```
* app.js 파일 
```js
// app.js 파일
const express = require('express');

const app = express();
// 포트 번호를 할당합니다. 
// app.set을 사용해서 데이터를 저장할 수 있습니다. 
app.set('port', process.env.PORT || 3000);

// 주소에 대한 라우터 경로를 지정합니다. 
// app.post, app.put, app.patch, app.delete, app.options등의 메서드를 지정할 수 있습니다. 
app.get('/', (req, res) => {
    res.send('Hello, Express');
    // html로 표시하고 싶다면 sendFile을 사용하면 됩니다. 
    //res.sendFile(path.join(__dirname, '/index.html'));
});

app.listen(app.get('port'), ()=> {
    console.log(app.get('port'), '번 포트에서 대기중');
});
```

## 자주 사용하는 미들웨어
* 미들웨어는 요청과 응답 중간에 위치하기 때문에 미들웨어라고 부릅니다.
* 미들웨어는 app.use와 함께 사용됨 
  * app.use(미들웨어) : 모든 요청에 미들웨어 실행
  * app.use('/abc', 미들웨어) : abc로 시작하는 요청에서 미들웨어 실행
  * app.post('/abc', 미들웨어) : abc로 시작하는 POST 요청에서 미들웨어 실행
* 미들웨어는 여러개 장착 될 수 있으며 next 함수를 통해서 다음으로 넘어갈 수 있습니다. 
* 요청 처리 미들웨어는 req, res, next의 인수를 가집니다. 
* 에러처리 미들웨어는 err, req, res, next의 인수를 가집니다. 
```js
app.use((req, res, next) => {
    console.log('모든 요청에서 다 호출 됩니다.')
    next();
});

app.get("/", (req, res, next) => {
    console.log('GET / 요청에서만 실행됩니다.');
    next();
}, (req, res) => {
    throw new Error("에러는 에러 처리 미들웨어로 갑니다.");
})

app.use((err, req, res, next) => {
    console.error(err);
    res.status(500).send(err.message);
})
```
* 실무에서 자주 사용하는 미들 웨어 패키지
  * npm i morgan cookie-parser express-session dotenv
```js
app.use(morgan('dev'));
app.use('/', express.static(path.join(__dirname, 'public')));
app.use(express.json());
app.use(express.urlencoded({extended : false}));
app.use(cookieParser(process.env.COOKIE_SECRET));
app.use(session({
    resave : false,
    saveUninitialized : false,
    secret : process.env.COOKIE_SECRET,
    cookie : {
        httpOnly : true,
        secure : false,
    },
    name : 'session-cookie',
}));
```

### morgan 패키지
  * 요청과 응답에 대한 정보를 콘솔에 기록합니다. 
  * `HTTP메서드 url HTTP상태코드 응답속도 - 응답 바이트` 형식으로 출력됩니다.
    * 예제 : `GET / 200 6.051 ms - 15`
### static 메서드
* 정적인 파일들을 제공하는 라우터 역활을 합니다.
* 요청 주소와 서버의 폴더 경로가 다르다면 외부에 경로가 노출되지 않습니다. 
```js
app.use('요청 경로', express.static('실제 경로'));
app.use('/', express.static(path.join(__dirname, 'public')));
```

### body-parser 
* 요청 본문에 있는 데이터를 해석해서 req.body 객체로 만들어주는 미들웨어입니다. 
* 보통 form데이터나 AJAX 요청의 데이터를 처리합니다. 
  * 멀티파트(이미지, 동영상, 파일) 데이터는 처리하지 못합니다. 
* 본문으로 데이터를 보내면 JSON 형식으로 변경합니다.
  * body에 URL-encoded 형식으로 name=zerochk&book=nodejs을 본문으로 보내면 { name : 'zerocho', book : 'nodejs'}로 변환
```js
// express에 기본으로 내장되어 있음
// json이나 URL-encoded 형식 외에 Raw, Text 형식을 추가로 해석할 때 사용하려면 따로 설치해야됨
app.use(express.json());
app.use(express.urlencoded({ extended : false}));
const bodyParser = require('body-parser');
app.use(bodyParser.raw());
app.use(bodyParser.text());
```

### cookie-parser
* 요청에 동봉된 쿠키를 해석해 req.cookies 객체로 만듭니다. 
* 해석된 쿠키들은 req.cookies 객체에 들어갑니다. name=zerocho 쿠키를 보내면 cookies는 `{name : 'zerocho'}`가 됩니다. 
```js
app.use(cookieParser(비밀키));
```
* 첫 인수로 비밀키를 넣어 줍니다. 비밀 키를 통해서 서명을 쿠키 값 뒤에 붙입니다.
  * 서명이 붙으면 req.cookies 대신 req.signedCookies 객체에 들어갑니다.
* cookie-parser는 쿠키를 생성할 때 쓰이지 않습니다.
  * 쿠키를 생성할 때는 `res.cookie`, `res.clearCookie` 메서드를 사용합니다. 
```js
res.cookie('name', 'zerocho', {
    expires : new Date(Date.now() + 900000),
    httpOnly : true,
    secure : true,
});
res.clearCookie('name', 'zerocho', {httpOnly : true, secure : true});
```

### express-session 
* 세션 관리용 미들웨어 입니다.
* 로그인 등의 이유로 세션을 구현하거나 특정 사용자를 위한 데이터를 임시적으로 저장 할 때 유용 합니다. 
* 세션은 req.session 객체 안에 유지됩니다.
```js
app.use(session({
    resave : false, 
    saveUninitialized : false,
    secret : process.env.COOKIE_SECRET,
    cookie : {
        httpOnly : true,
        secure : false,
    },
    name : 'session-cookie',
}))

req.session.name = 'zerocho';       // 세션 등록
req.sessionID;                      // 세션 아이디 확인
req.session.destory();              // 세션 모두 제거
```

### 미들웨어의 특성 활용하기 
* use 메서드는 동시에 여러개의 미들웨어를 등록해서 사용할 수 있습니다.
  * 메서드 내부에서 next 함수를 호출 합니다. 
  * 주의 할점은 정적파일 전송할 때는 내부적으로 `next` 대신에 `res.sendFile` 메서드로 응답합니다.
```js
app.use(
    morgan('dev'),
    express.json(),
    express.urlencoded({extended : false}),
    cookieParser(process.env.COOKIE_SECRET),
    );
```
* 